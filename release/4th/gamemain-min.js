function GameObject(){let t,e,i,s,r,n;this.r=0,this.vr=0,this.x=0,this.y=0,this.old_X=0,this.old_y=0,this.triggerDelay=0,this.op={ptr:0,x:Array(40),y:Array(40),r:Array(40)},this.turlet=new function(){let t=0;this.vecToR=function(t,e){return(270+(0==t?e>=0?180:0:Math.atan(e/t)*(180/Math.PI)+(t>=0?90:270)))%360},this.check=function(e){let i=Math.trunc(180+e-t)%360;i>=180&&t++,i<=180&&t--,i>=210&&(t+=3),i<=150&&(t-=3),i>=270&&(t+=3),i<=90&&(t-=3)},this.move=function(e){t=(t+e)%360},this.vector=function(){return t}};let h,o=0;this.spriteItem;let a=!1;function l(t,e,i,s=0,r=360){for(let n=s;n<r;n+=30)sp=t.sprite.itemCreate("BULLET_P",!0,8,8),sp.pos(e,i,n),sp.move(n,2,30)}function p(t,e){w={x:this.x,y:this.y,c:"white",r:this.r-90,draw(t){t.beginPath(),t.strokeStyle=this.c,t.lineWidth=2,t.moveTo(this.x+12*Math.cos(this.r*(Math.PI/180)),this.y+12*Math.sin(this.r*(Math.PI/180))),t.lineTo(this.x+24*Math.cos(this.r*(Math.PI/180)),this.y+24*Math.sin(this.r*(Math.PI/180))),t.stroke()}},e.putFunc(w)}this.init=function(o){this.r=0,this.vr=0,this.x=this.spriteItem.x,this.y=this.spriteItem.y,this.old_x=this.x,this.old_y=this.y,this.triggerDelay=0,this.op.ptr=0,this.op.x.fill(this.x),this.op.y.fill(this.y),this.op.r.fill(0),this.spriteItem.mode=0,t={sp:o.sprite.itemCreate("Turlet",!1,32,32),re:!1},t.sp.customDraw=p,t.sp.priority=1,e={sp:o.sprite.itemCreate("FRIEND_P",!0,32,32),re:!1},i={sp:o.sprite.itemCreate("Turlet",!1,32,32),re:!1},s={sp:o.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1},r={sp:o.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1},n={sp:o.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1},h=!1,a=!1,e.sp.dispose(),e.re=!0,i.sp.dispose(),i.re=!0,s.sp.dispose(),s.re=!0,r.sp.dispose(),r.re=!0,n.sp.dispose(),n.re=!0},this.step=function(p,c,m){this.spriteItem.collisionEnable=!m.clrf;let u=c.x,f=c.y,d=c.trigger,g=!(!c.left&&!c.right);if(d&&this.triggerDelay<p.time()){this.triggerDelay=p.time()+250;let t=p.sprite.itemCreate(a?"BULLET_P2":"BULLET_P",!0,8,8),i=this.turlet.vector(),s=this.x+16*Math.cos(Math.PI/180*i),r=this.y+16*Math.sin(Math.PI/180*i);t.pos(s,r,0,.6),t.move((i+90)%360,6,3e3),e.sp.living&&(op=this.op,t=p.sprite.itemCreate("BULLET_P",!0,8,8),t.pos(op.x[op.ptr%op.x.length],op.y[op.ptr%op.x.length],0,.6),t.move((op.r[op.ptr%op.x.length]+90)%360,6,3e3))}let y=3+o;Boolean(this.spriteItem.slow)&&(this.spriteItem.slow?(y/=2,this.spriteItem.slow=!1):this.spriteItem.slow=!1);let w=y*u,v=y*f;if(m.clrf&&0==w&&0==v){p.time(),m.time;w=Math.trunc((320-this.x)/40),v=Math.trunc((320-this.y)/40)}let x=!1,I=!!Boolean(this.spriteItem.wall)&&!!this.spriteItem.wall,b=!1,M=!1,P=!1,_=!1;this.spriteItem.living?(_=!!Boolean(this.spriteItem.mode)&&0!=this.spriteItem.mode,_&&(0!=(1&this.spriteItem.mode)&&(s.sp.living||(s={sp:p.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1})),0!=(2&this.spriteItem.mode)&&(r.sp.living||(r={sp:p.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1}),n.sp.living||(n={sp:p.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1})),0!=(4&this.spriteItem.mode)&&(e.sp.living||(e={sp:p.sprite.itemCreate("FRIEND_P",!0,32,32),re:!1},i={sp:p.sprite.itemCreate("Turlet",!1,32,32),re:!1})),0!=(8&this.spriteItem.mode)&&(a=!a),this.spriteItem.mode=0),h=!1):h||(l(p,this.x,this.y),h=!0,t.sp.hide(),e.sp.living&&e.sp.dispose(),s.sp.living&&s.sp.dispose(),r.sp.living&&r.sp.dispose(),n.sp.living&&n.sp.dispose(),a=!1),e.sp.living||i.sp.living&&i.sp.dispose(),s.sp.living&&(b=!!Boolean(s.wall)&&!!s.wall,s.wall=!1),r.sp.living&&(M=!!Boolean(s.wall)&&!!r.wall,r.wall=!1),n.sp.living&&(P=!!Boolean(s.wall)&&!!n.wall,n.wall=!1),x=!!(I||b||M||P),x&&(this.x=this.old_x,this.y=this.old_y,this.spriteItem.wall=!1),h||(g||this.turlet.check(this.r),0!=w||0!=v?(this.old_x=Math.trunc(this.x),this.old_y=Math.trunc(this.y),this.x=this.x+w,this.y=this.y+v,this.x<32&&(this.x=32),this.x>608&&(this.x=608),this.y<32&&(this.y=32),this.y>432&&(this.y=432),this.r=this.turlet.vecToR(w,v),op=this.op,op.x[op.ptr]=Math.trunc(this.x),op.y[op.ptr]=Math.trunc(this.y),op.r[op.ptr]=this.turlet.vector(),op.ptr++,op.ptr=op.ptr%op.x.length):(c.left&&this.turlet.move(-1),c.right&&this.turlet.move(1)))},this.draw=function(h){if(e.sp.living){for(let t=0;t<this.op.x.length-5;t+=3){let e=this.op;h.screen[0].fill(e.x[(e.ptr+t)%e.x.length]-2,e.y[(e.ptr+t)%e.x.length]-2,3,3,"gray")}let t=this.op;e.sp.pos(t.x[t.ptr%t.x.length],t.y[t.ptr%t.x.length],t.r[t.ptr%t.x.length]+90,.8),i.sp.pos(t.x[t.ptr%t.x.length],t.y[t.ptr%t.x.length],t.r[t.ptr%t.x.length]+90,.8),e.sp.view(),i.sp.view()}else e.re||(l(h,op.x[op.ptr%op.x.length],op.y[op.ptr%op.x.length]),i.sp.dispose(),e.re=!0);let o=Math.trunc(this.x),a=Math.trunc(this.y);s.sp.living?(s.sp.pos(Math.trunc(o+20*Math.cos(this.r*(Math.PI/180))),Math.trunc(a+20*Math.sin(this.r*(Math.PI/180))),(this.r+90)%360,1),s.sp.view()):s.re||(l(h,o+20*Math.cos(this.r*(Math.PI/180)),a+20*Math.sin(this.r*(Math.PI/180))),s.re=!0),r.sp.living?(r.sp.pos(Math.trunc(o+20*Math.cos((this.r-90)*(Math.PI/180))),Math.trunc(a+20*Math.sin((this.r-90)*(Math.PI/180))),this.r%360,1),r.sp.view()):r.re||(l(h,o+16*Math.cos((this.r-90)*(Math.PI/180)),a+16*Math.sin((this.r-90)*(Math.PI/180))),r.re=!0),n.sp.living?(n.sp.pos(Math.trunc(o+17*Math.cos((this.r+90)*(Math.PI/180))),Math.trunc(a+17*Math.sin((this.r+90)*(Math.PI/180))),this.r%360,1),n.sp.view()):n.re||(l(h,Math.trunc(o+16*Math.cos((this.r+90)*(Math.PI/180))),Math.trunc(a+16*Math.sin((this.r+90)*(Math.PI/180)))),n.re=!0),this.spriteItem.pos(o,a,(this.r+90)%360,1),this.spriteItem.view(),t.sp.living&&(t.sp.pos(o,a,(this.turlet.vector()+90)%360,1),t.sp.r=(this.turlet.vector()+90)%360,t.sp.view())}}function GameObj_Friend(){}function GameObj_Enemy(){}function GameObj_FlyCanon(){this.r=0,this.vr=0,this.x=0,this.y=0,this.old_X=0,this.old_y=0,this.triggerDelay=0,this.triggerCount=0;let t,e,i;function s(t,e,i){const s=t.sprite.itemList();let r=-1;for(let t in s)"Player"==s[t].id&&(r=t);let n=-1;return-1!=r&&(n=function(t,e){return(270+(0==t?e>=0?180:0:Math.atan(e/t)*(180/Math.PI)+(t>=0?90:270)))%360}(e-s[r].x,i-s[r].y)),n}this.spriteItem,this.init=function(s,r=1e3,n=10){this.r=this.spriteItem.r,this.vr=0,this.x=this.spriteItem.x,this.y=this.spriteItem.y,this.old_X=this.x,this.old_y=this.y,this.triggerDelay=0,this.triggerCount=0,t=!1,e=r,i=n},this.step=function(r,n,h){if(this.spriteItem.living){if(this.triggerDelay<r.time()){if(this.triggerDelay=r.time()+e,this.triggerCount++,this.triggerCount%2>0){let t=r.sprite.itemCreate("BULLET_E",!0,4,4),e=s(r,this.x,this.y),i=-1!=e?e-90:this.r+(r.time()%180+90);this.triggerCount%3==0&&(i=this.r);let n=this.x,h=this.y;t.pos(n,h,0,1),t.move(i,3,3e3)}this.r+=i,this.spriteItem.move(this.r,2,100)}t=!1}else t||(!function(t,e,i,s=0,r=360){for(let n=s;n<r;n+=30)sp=t.sprite.itemCreate("BULLET_E",!0,8,8),sp.pos(e,i,n),sp.move(n,2,30)}(r,this.x,this.y),t=!0);!!Boolean(this.spriteItem.wall)&&!!this.spriteItem.wall&&(this.r+=5*i,this.r=this.r%360,this.spriteItem.vx=0,this.spriteItem.vy=0,this.spriteItem.wall=!1),Boolean(this.spriteItem.slow)&&(this.spriteItem.slow?(this.spriteItem.vx/=1.05,this.spriteItem.vy/=1.05,this.spriteItem.slow=!1):this.spriteItem.slow=!1),t||(this.old_x=this.x,this.old_y=this.y,this.x=this.spriteItem.x,this.y=this.spriteItem.y,this.r=this.spriteItem.r,this.x<32&&(this.spriteItem.x=32),this.x>608&&(this.spriteItem.x=608),this.y<32&&(this.spriteItem.y=32),this.y>432&&(this.spriteItem.y=432))},this.draw=function(t){this.spriteItem.living&&this.spriteItem.view()}}function GameObj_Horming(){}function GameObj_GradeUpItem(){this.triggerDelay=0;let t;function e(t,e,i){const s=t.sprite.itemList();let r=-1;for(let t in s)"Player"==s[t].id&&(r=t);let n=-1;return-1!=r&&(n=function(t,e){return(270+(0==t?e>=0?180:0:Math.atan(e/t)*(180/Math.PI)+(t>=0?90:270)))%360}(e-s[r].x,i-s[r].y)),n}this.mode=0,this.blink=!0,this.barth=!0,this.spriteItem,this.init=function(e){this.triggerDelay=e.time()+250,this.mode=0,this.barth=!0,this.spriteItem.mode=this.mode,this.spriteItem.drawDesignData=i,this.spriteItem.blink=!0,t=!1,this.spriteItem.normalDrawEnable=!1,this.spriteItem.customDraw=s,this.spriteItem.moveFunc=function(){this.alive--,this.x+=this.vx,this.y+=this.vy}},this.step=function(i,s,r){if(this.spriteItem.collisionEnable=!this.barth,r.clrf&&r.time+750>i.time()){let t=e(i,this.spriteItem.x,this.spriteItem.y);this.spriteItem.move((t+260)%360,4,1)}if(this.spriteItem.living?(this.triggerDelay<i.time()&&(this.triggerDelay=i.time()+250,this.mode=this.spriteItem.mode!=this.mode?this.spriteItem.mode:this.mode,this.spriteItem.priority=this.mode,this.blink=!this.blink,this.spriteItem.blink=this.blink,this.barth=!1),t=!1):t||(t=!0),t)return;const n=this.spriteItem.x,h=this.spriteItem.y;this.spriteItem.r;n<32&&(this.spriteItem.x=32),n>608&&(this.spriteItem.x=608),h<32&&(this.spriteItem.y=32),h>432&&(this.spriteItem.y=432)},this.draw=function(t){this.spriteItem.living&&this.spriteItem.view()};const i={str:[[" --","正面","側面","子機","弾種"],["None","FWD","SIDE"," OPT","CHNG"]],color:[["black","peru","navy","teal","indigo"],["rgb(64,64,64)","orange","blue","green","blueviolet"]]};function s(t,e){const i=this.drawDesignData.str,s=this.drawDesignData.color;let r=this.blink?0:1;const n=Math.trunc(this.x-this.collision.w/2),h=Math.trunc(this.y-this.collision.h/2),o=this.collision.w,a=this.collision.h;e.fill(n,h,o,a,"white"),e.fill(n+1,h+1,o-2,a-2,s[r][this.mode]),t.kanji.print(i[r][this.mode],n+2,h+4)}}function SceneGame(){let t,e,i,s,r,n,h,o,a,l;Array(40),Array(40);function p(){let t,e;this.run=function(){t++},this.set=function(){e=0,t=0},this.check=function(){return t!=e}}this.state=function(){return{ene:o,result:i,time:n,stage:i.stage,score:i.score,delay:s,block:undefined,collision:0,sprite:e.length,clear:i.clrf,gameover:i.govf}},this.init=function(i){a=new p,t=[],l=new StageControl(i),l.init(),e=i.sprite.itemList(),this.reset(i)},this.reset=function(n){l.init(),t=[],n.sprite.itemFlash(),h=new GameObject,h.spriteItem=n.sprite.itemCreate("Player",!0,28,28),h.spriteItem.pos(320,320),h.init(n),t.push(h),l.change(1,t);for(let t in this.spriteTable)e[t].visible=!1;o={now:3,max:3,before:this.now},i={score:0,time:n.time(),stage:1,clrf:!1,govf:!1},s=0,r=0},this.step=function(r,p,c){n=Math.trunc((r.time()-i.time)/100);for(let e of t)e.step(r,p,i);if(s<r.time()){s=r.time()+500,o.before=o.now,i.clrf=!1,r.sprite.itemIndexRefresh();let e=0,n=r.sprite.itemList();for(let t of n)"Enemy"==t.id&&e++;if(h.spriteItem.living||(o.now--,o.now>0&&(h.spriteItem=r.sprite.itemCreate("Player",!0,28,28),h.spriteItem.pos(320,320),h.x=320,h.y=320)),0==e){let e=1e4-(r.time()-i.time);i.score+=e<0?100:e+100,i.time=r.time(),i.stage++;let n=[];for(let e in t)t[e].spriteItem.living&&n.push(t[e]);t=n,l.change(i.stage,t);let h=r.sprite.itemList();for(let t of h)"BULLET_P"==t.id&&t.dispose(),"BULLET_E"==t.id&&t.dispose();i.clrf=!0,s=r.time()+1500}o.now<=0&&(s=r.time()+3e3,o.now=0,i.govf=!0)}r.sprite.CollisionCheck(),e=r.sprite.itemList();for(let i in e){let s=e[i];if(s.living&&(s.collisionEnable&&s.visible)){if("Player"==s.id||"FRIEND_P"==s.id||"ARMOR_P"==s.id){let t=s.hit;for(let e in t){let i=t[e];i.visible&&("BULLET_E"==i.id&&(l.mapDamage(s),s.dispose(),i.dispose()),"Player"==s.id&&"POWERUP"==i.id&&(i.mode>0&&(Boolean(s.mode)&&isNaN(s.mode)?s.mode+=Math.pow(2,i.mode-1):s.mode=Math.pow(2,i.mode-1)),i.dispose()))}}if("Enemy"==s.id){let e=s.hit;for(let i in e){let n=e[i];if(n.visible&&"BULLET_P"==n.id.substring(0,8)){l.mapDamage(s);let e=new GameObj_GradeUpItem;e.spriteItem=r.sprite.itemCreate("POWERUP",!1,28,16),e.spriteItem.pos(s.x,s.y),e.init(r),t.push(e),s.dispose(),n.dispose()}}}if("BULLET_P"==s.id.substring(0,8)){let t=s.hit;for(let e in t){let i=t[e];i.visible&&("BULLET_E"==i.id&&(l.mapDamage(s),s.dispose(),i.dispose()))}}if("BULLET_E"==s.id){let t=s.hit;for(let e in t){let i=t[e];i.visible&&("BULLET_P"==s.id.substring(0,8)&&(l.mapDamage(s),s.dispose(),i.dispose()))}}if("POWERUP"==s.id){let t=s.hit;for(let e in t){let i=t[e];i.visible&&("BULLET_"==i.id.substring(0,7)&&(s.mode++,s.mode>4&&(s.mode=0),i.dispose()),i.id==s.id&&Math.trunc(i.x)==Math.trunc(s.x)&&Math.trunc(i.y)==Math.trunc(s.y)&&(s.vx=2*(4*Math.random()-2),s.vy=2*(4*Math.random()-2)))}}}}!function(t){for(let e in t){let i=t[e];(i.x<0||i.x>640||i.y<0||i.y>464)&&((i.x<0||i.x>640)&&i.dispose(),(i.y<0||i.y>464)&&i.dispose())}}(r.sprite.itemList()),l.step(r,p,i),a.run()},this.draw=function(e){a.check();if(1){let t=e.sprite.itemList();for(let i in t)"BULLET"==t[i].id.substring(0,6)&&e.screen[0].fill(t[i].x-t[i].collision.w/2,t[i].y-t[i].collision.h/2,t[i].collision.w,t[i].collision.h,"BROWN")}if(l.draw(e),!i.govf)for(let i of t)i.draw(e);a.set()}}class GameTask_Main extends GameTask{_x=0;_y=0;_sm={};_dtt=0;_result;_titlef;titlewait;_wh=0;scene;_dv;constructor(t){super(t)}pre(t){this.scene=[],this.scene.Game=new SceneGame,this.scene.UI=new SceneGameUI,this.scene.Debug=new SceneDebug,this.scene.Result=new SceneResult,this.scene.GameOver=new SceneGameOver,this.scene.Title=new SceneTitle,this.scene.Gpad=new SceneGPad,t.sprite.setPattern("Player",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:32,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("Turlet",{image:"SPGraph",wait:0,pattern:[{x:0,y:32,w:32,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("BULLET_P",{image:"SPGraph",wait:0,pattern:[{x:48,y:48,w:8,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("BULLET_P2",{image:"SPGraph",wait:0,pattern:[{x:16,y:16,w:8,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("Enemy",{image:"SPGraph",wait:10,pattern:[{x:32,y:32,w:32,h:32,r:0,fv:!1,fh:!1},{x:32,y:64,w:32,h:32,r:0,fv:!1,fh:!1},{x:32,y:96,w:32,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("BULLET_E",{image:"SPGraph",wait:0,pattern:[{x:48,y:48,w:4,h:16,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("ARMOR_P",{image:"SPGraph",wait:0,pattern:[{x:0,y:64,w:32,h:8,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("ARMOR_E",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:2,h:2,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("FRIEND_P",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:32,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("POWERUP",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:2,h:2,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("block",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:2,h:2,r:0,fv:!1,fh:!1}]}),this.scene.Game.init(t),this._initGame(t),this._sm={x:0,y:0,old_x:0,old_y:0}}_initGame(t){this.scene.Game.reset(t),this._titlef=!0,this.titlewait=t.time()+1e3}step(t){let e=t.keyboard.check(),i=!1;Boolean(e[65])&&e[65]&&(i=!0);let s=!1;Boolean(e[68])&&e[68]&&(s=!0);let r=!1;Boolean(e[87])&&e[87]&&(r=!0);let n=!1;Boolean(e[83])&&e[83]&&(n=!0);let h=!1;Boolean(e[81])&&e[81]&&(h=!0);let o=!1;Boolean(e[69])&&e[69]&&(o=!0);let a=!1;Boolean(e[38])&&e[38]&&(a=!0);let l=!1;Boolean(e[40])&&e[40]&&(l=!0);let p=!1;Boolean(e[37])&&e[37]&&(p=!0);let c=!1;Boolean(e[39])&&e[39]&&(c=!0);let m=!1;Boolean(e[32])&&e[32]&&(m=!0);let u=!1;Boolean(e[90])&&e[90]&&(u=!0);let f=!1;Boolean(e[36])&&e[36]&&(f=!0);let d=!1;Boolean(e[80])&&e[80]&&(d=!0);let g=t.gamepad.check(),y=t.gamepad.btn_lb,w=t.gamepad.btn_rb,v=t.gamepad.btn_a,x=t.gamepad.btn_x,I=t.gamepad.btn_back,b=t.gamepad.r,M=t.gamepad.axes;a=!(!a&&!r),l=!(!l&&!n),p=!(!p&&!i),c=!(!c&&!s),!(!f&&!I)&&(document.fullscreenElement||t.systemCanvas.requestFullscreen()),g&&-1!=b?(this._x=M[0],this._y=M[1]):(this._x=p?-1:c?1:0,this._y=a?-1:l?1:0);let P=y||u||h,_=w||u||o,E=v||x||m,G={x:this._x,y:this._y,trigger:E,left:P,right:_,keycode:e},L=this.scene.Game.state();this._result=L.result,this._titlef?(L.block=0,L.sprite=0,this.scene.Title.step(t,G,{delay:this.titlewait})&&(this._titlef=!1)):L.gameover?this.scene.GameOver.step(t,G,L)&&this._initGame(t):this.scene.Game.step(t,G),this._result.clrf&&this.scene.Result.step(t,G),this.scene.UI.step(t,G,L),this.scene.Debug.step(t,G,L),this._dv=!!d,this._dv&&this.scene.Gpad.step(t,G,L)}draw(t){this._titlef||this.scene.Game.draw(t),this._titlef||this.scene.UI.draw(t),this._dv&&this.scene.Debug.draw(t),this._result.clrf&&this.scene.Result.draw(t),this._result.govf&&this.scene.GameOver.draw(t),this._titlef&&this.scene.Title.draw(t),this._dv&&this.scene.Gpad.draw(t)}}function main(){const t=new GameCore({canvasId:"layer0",screen:[{resolution:{w:640,h:480,x:0,y:0}}]});pictdata(t);const e=SpriteFontData();for(let i in e)t.setSpFont(e[i]);t.kanji=new fontPrintControl(t,t.asset.image.ASCII.img,6,8,t.asset.image.JISLV1.img,12,8),t.task.add(new GameTask_Main("main")),t.screen[0].setBackgroundcolor("black"),t.screen[0].setInterval(1),t.run()}function SpriteFontData(){let t=[];for(let e=0;e<7;e++)for(j=0;j<16;j++)ptn={x:12*j,y:16*e,w:12,h:16},t.push(ptn);let e=[],i=["white","red","green","blue"];for(let t=0;t<=3;t++){let s=[];for(let t=0;t<7;t++)for(let e=0;e<16;e++)ptn={x:6*e,y:8*t+16,w:6,h:8},s.push(ptn);e[i[t]]=s}return[{name:"std",id:"ASCII",pattern:e.white},{name:"8x8red",id:"ASCII",pattern:e.red},{name:"8x8green",id:"ASCII",pattern:e.green},{name:"8x8blue",id:"ASCII",pattern:e.blue},{name:"8x8white",id:"ASCII",pattern:e.white}]}function pictdata(t){t.asset.imageLoad("SPGraph","pict/cha.png"),t.asset.imageLoad("JISLV1","pict/k12x8_jisx0208c.png"),t.asset.imageLoad("ASCII","pict/k12x8_jisx0201c.png")}function SceneGameUI(){let t,e,i;this.step=function(s,r,n){t=n.ene,e=n.result,i=n.time},this.draw=function(i){let s="";for(let e=1;e<t.now;e++)s+="▲";i.kanji.print("PLAYER:"+s,0,448),i.kanji.print("STAGE :"+e.stage,0,456)}}function SceneResult(){this.step=function(t,e){},this.draw=function(t){t.font.std.putchr("STAGE CLEAR",220,244,3),t.font.std.putchr("STAGE CLEAR",320,464)}}function SceneTitle(){let t;const e=["テーマ  アップグレード/強化(土日スレ16)","","     TANK BATTLE Style/ERA-TANK","","","","","","           START SPACE KEY","                     or GamePad Button X/A","","","","[操作]移動    : WASD or 矢印キー or GamePad 左アナログスティック","      攻撃    : SPACE key or GamePad Button X/A","攻撃方向の固定: Z key  or GamePad Button L/R","停止時砲塔旋回: Q,Ekey or GamePad Button L/R","","","敵を倒すと出てくるアップグレードパーツ(弾を当てて切り替え)","[ -  /None] 効果なし ","[正面/FWD ] 正面追加装甲","[側面/SIDE] 側面追加装甲","[子機/ OPT] 有線ドローン(OPTION)","[弾種/CHNG] 弾の種類切り替え(通常<->ブロック貫通)","  注：重複効果はありません。"];this.step=function(e,i,s){t=i,delay=s.delay-e.time()<0;let r=!1;return delay&&i.trigger&&(r=!0),r},this.draw=function(t){for(let i in e)t.kanji.print(e[i],160,140+8*i)}}function SceneGameOver(){let t,e,i;this.step=function(s,r,n){if(t=n.stage,e=Math.trunc(n.score),i=n.delay-s.time()<0,i&&(s.sprite.itemFlash(),r.trigger))return!0},this.draw=function(t){t.font.std.putchr("GAME OVER",220,248,4),t.font["8x8white"].putchr(":"+(i?"OK":"WAIT"),320,456)}}function SceneDebug(){let t,e,i,s,r;this.step=function(n,h,o){t=o.block,e=n.deltaTime().toString().substring(0,5),i=o.collision,s=o.sprite,r=h},this.draw=function(t){t.font["8x8white"].putchr("DeltaT:"+e,540,0);let i=0!=r.x?r.x>0?"R":"L":"-",s=0!=r.y?r.y>0?"D":"U":"-",n=r.trigger?"T":"-",h=r.right?"S":"-";t.font["8x8green"].putchr("Input:"+s+":"+i+":"+n+":"+h,540,16)}}function SceneGPad(){let t;this.step=function(e,i,s){t=e.gamepad.infodraw();let r=i.keycode,n="";for(let t in r)Boolean(r[t])&&(n+="["+t+"]");t.push(""),t.push("[Keyboard]"),t.push(n)},this.draw=function(e){for(let i in t)e.font["8x8white"].putchr(t[i],0,48+8*i)}}function GameSpriteControl(t){let e,i,s=[],r=[],n=!0;function h(){function t(){this.alive--,this.x+=this.vx,this.y+=this.vy,this.alive<=0?this.visible=!1:this.visible=!0}this.x=0,this.y=0,this.r=0,this.z=0,this.vx=0,this.vy=0,this.priority=0,this.collisionEnable=!0,this.collision={w:0,h:0},this.id="",this.count=0,this.pcnt=0,this.visible=!1,this.hit=[],this.alive=0,this.index=0,this.living=!0,this.normalDrawEnable=!0,this.beforeCustomDraw=!1,this.customDraw=function(t,e){},this.moveFunc,this.view=function(){this.visible=!0},this.hide=function(){this.visible=!1},this.pos=function(t,e,i=0,s=0){this.x=t,this.y=e,this.r=i,this.z=s},this.move=function(t,e,i){this.visible=!0;let s=(t-90)*(Math.PI/180);this.vx=Math.cos(s)*e,this.vy=Math.sin(s)*e,this.r=t,this.alive=i},this.moveFunc=t,this.stop=function(){this.alive=0,this.vx=0,this.vy=0},this.dispose=function(){this.alive=0,this.visible=!1,this.living=!1},this.put=function(t,i,s=0,n=1){Boolean(r[this.id])?(o(r[this.id].image,r[this.id].pattern[this.pcnt],t,i,s,n),this.count++,this.count>r[this.id].wait&&(this.count=0,this.pcnt++),this.pcnt>r[this.id].pattern.length-1&&(this.pcnt=0)):e.fillText(this.index+" "+this.count,t,i)},this.reset=function(){this.x=0,this.y=0,this.r=0,this.z=0,this.vx=0,this.vy=0,this.priority=0,this.collisionEnable=!0,this.collision={w:0,h:0},this.id="",this.count=0,this.pcnt=0,this.visible=!1,this.hit=[],this.alive=0,this.index=0,this.living=!0,this.normalDrawEnable=!0,this.customDraw=function(t,e){},this.beforeCustomDraw=!1,this.moveFunc=t},this.debug=function(){let t=[];return Object.entries(this).forEach((function(e){let i=String(e).split(","),s=i[0];s.length<13&&(s+=" ".repeat(13),s=s.substring(0,13));let r=i[1].substring(0,15);t.push("."+s+":"+r)})),t.push(""),t.push("Object.entries end."),t}}function o(t,i,s,r,n,h,o){if(Boolean(n)||(n=i.r),Boolean(o)||(o=255),Boolean(h)||(h=1),!i.fv&&!i.fh&&0==n&&255==o)e.drawImgXYWHXYWH(t,i.x,i.y,i.w,i.h,s+-i.w/2*h,r+-i.h/2*h,i.w*h,i.h*h);else{let a=i.fv?-1:1,l=i.fh?-1:1;e.spPut(t,i.x,i.y,i.w,i.h,-i.w/2*h,-i.h/2*h,i.w*h,i.h*h,l,0,0,a,s,r,o,n)}}this.itemCreate=function(t,e=!1,i=0,r=0){const n=new h;let o=s.length;return s.push(n),n.reset(),n.index=o,n.id=t,n.count=0,n.pcnt=0,n.collisionEnable=e,n.collision={w:i,h:r},n},this.itemList=function(){return s},this.itemFlash=function(){s=[]},this.itemIndexRefresh=function(){let t=[];for(let e in s)s[e].living&&t.push(s[e]);for(let e in t)t[e].index=e;return s=t,s},this.manualDraw=function(t=!0){n=!t},this.useScreen=function(s){i=t.screen[s],e=i.buffer},this.setPattern=function(e,i){r[e]={image:t.asset.image[i.image].img,wait:i.wait,pattern:i.pattern}},this.CollisionCheck=function(){let t=[];for(let e in s){let i=s[e];i.living&&i.collisionEnable&&t.push(i)}for(let e in t){let i=t[e];i.hit=[];for(let s in t)if(e!=s){let e=t[s];Math.abs(i.x-e.x)<i.collision.w/2+e.collision.w/2&&Math.abs(i.y-e.y)<i.collision.h/2+e.collision.h/2&&i.hit.push(e)}}};const a=new function(){let t=[];this.add=e=>{t.push(e)},this.sort=()=>{t.sort(((t,e)=>t.priority-e.priority))},this.buffer=()=>t,this.reset=()=>{t=[]}};this.allDrawSprite=function(){if(n){a.reset();for(let t in s){let e=s[t];e.living&&a.add(e)}a.sort();let n=a.buffer();for(let s in n){let h=n[s];h.alive>0&&h.moveFunc(),h.visible&&(h.beforeCustomDraw&&h.customDraw(t,i),h.normalDrawEnable&&(Boolean(r[h.id])?(o(r[h.id].image,r[h.id].pattern[h.pcnt],h.x,h.y,h.r,h.z),h.count++,h.count>r[h.id].wait&&(h.count=0,h.pcnt++),h.pcnt>r[h.id].pattern.length-1&&(h.pcnt=0)):e.fillText(s+" "+h.count,h.x,h.y)),h.beforeCustomDraw||h.customDraw(t,i))}}}}function StageControl(t){const e=60,i=80;let s,r,n,h=t;function o(t,e,i,r,n){for(let h=e;h<e+r;h++)for(let e=t;e<t+i;e++)s[h][e].on=n.on,s[h][e].break=n.break,s[h][e].hit=n.hit,s[h][e].hp=n.hp}this.init=function(){n=1,s=function(t){let s=new Array(e);for(let r=0;r<e;r++){s[r]=new Array(i);for(let e=0;e<i;e++)s[r][e]={},s[r][e].on=t.on,s[r][e].break=t.break,s[r][e].hit=t.hit,s[r][e].hp=t.hp}return s}({on:!1,break:!1,hit:!1,hp:5})},this.change=function(t,e){n=t;!function(t){const e=Math.trunc(i/6),s=Math.trunc(12);let r=parseInt(t,16);for(let t=0;t<5;t++)for(let i=0;i<6;i++)0!=(1&r)&&o(i*e,t*s,e,s,{on:!0,break:!1,hit:!1,hp:1}),r>>=1}(["00000000","0000C000","00000080","00000400","00080000","00400000","00021000"][n%7]);let s=new GameObj_FlyCanon;s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28);let r=n%2==0?-1:1,a=Math.trunc(n/10)+1,l=Math.trunc(300*Math.random());s.spriteItem.pos(320+160*r,30),s.init(h,1e3/a+l,10/a*r),e.push(s),n>=3&&(l=Math.trunc(300*Math.random()),s=new GameObj_FlyCanon,s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28),s.spriteItem.pos(320,30),s.spriteItem.move(180,2,1e3),s.init(h,1e3/a+l,5*r),e.push(s)),n>=5&&(l=Math.trunc(300*Math.random()),s=new GameObj_FlyCanon,s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28),s.spriteItem.pos(320-160*r,30),s.init(h,1e3/a+l,10/a*-r),e.push(s)),n>=7&&(l=Math.trunc(300*Math.random()),s=new GameObj_FlyCanon,s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28),s.spriteItem.pos(320-280*r,30),s.spriteItem.move(180,2,1e3),s.init(h,1e3/a+l,10/a*-r),e.push(s),l=Math.trunc(300*Math.random()),s=new GameObj_FlyCanon,s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28),s.spriteItem.pos(320+280*r,30),s.spriteItem.move(180,2,1e3),s.init(h,1e3/a+l,10/a*r),e.push(s))},this.step=function(t,e,i){let r=t.sprite.itemList();for(let t in r){let e=r[t],i=r[t];if(!i.living)continue;if(!i.collisionEnable)continue;if(!i.visible)continue;let s=e.collision.w,h=e.collision.h;for(let t=Math.trunc((e.x-s/2)/8);t<=Math.trunc((e.x+s/2)/8);t++)for(let i=Math.trunc((e.y-h/2)/8);i<=Math.trunc((e.y+h/2)/8);i++)n(e,t,i)}function n(t,e,i){i>=0&&i<s.length&&e>=0&&e<s[i].length&&(s[i][e].on&&("BULLET_P"==t.id&&(s[i][e].hp--,s[i][e].hp<0&&(s[i][e].on=!1,s[i][e].break=!0,s[i][e].hit=!1),t.dispose()),"BULLET_P2"==t.id&&(s[i][e].hp--,s[i][e].hp<0&&(s[i][e].on=!1,s[i][e].break=!0,s[i][e].hit=!1)),"BULLET_E"==t.id&&(s[i][e].hp--,s[i][e].hp<0&&(s[i][e].on=!1,s[i][e].break=!0,s[i][e].hit=!1),t.dispose()),"Player"==t.id&&(t.wall=!0,s[i][e].on=!1,s[i][e].break=!0,s[i][e].hit=!0),"ARMOR_P"==t.id&&(t.wall=!0),"Enemy"==t.id&&(t.wall=!0)),s[i][e].hit&&("Player"==t.id&&(t.slow=!0),"Enemy"==t.id&&(t.slow=!0)))}},this.mapDamage=function(t){let r=t,n=r.collision.w,h=r.collision.h;for(let t=Math.trunc((r.x-n/2)/8);t<=Math.trunc((r.x+n/2)/8);t++)for(let n=Math.trunc((r.y-h/2)/8);n<=Math.trunc((r.y+h/2)/8);n++)t>=0&&t<i&&n>=0&&n<e&&(s[n][t].hit=!0)},this.draw=function(t){let n=Math.trunc(t.time()/250)%2;r=0;for(let h=0;h<e;h++)for(let e=0;e<i;e++)s[h][e].on&&(0!=s[h][e].hp?(t.screen[0].fill(8*e,8*h,8,8,"lightgray"),t.screen[0].fill(8*e,8*h,7,7,"gray")):t.screen[0].fill(8*e+1,8*h+1,5,5,"gray"),r++),s[h][e].hit&&(0==n?t.screen[0].fill(8*e+4,8*h+4,2,1,"red"):t.screen[0].fill(8*e+4,8*h+4,1,1,"red"))}}