function GameObject(){let t,e,i,r,n,h;this.r=0,this.vr=0,this.x=0,this.y=0,this.old_X=0,this.old_y=0,this.triggerDelay=0,this.op={ptr:0,x:Array(40),y:Array(40),r:Array(40)},this.turlet=new function(){let t=0;this.vecToR=function(t,e){return(270+(0==t?e>=0?180:0:Math.atan(e/t)*(180/Math.PI)+(t>=0?90:270)))%360},this.check=function(e){let i=Math.trunc(180+e-t)%360;i>=180&&t++,i<=180&&t--,i>=210&&(t+=3),i<=150&&(t-=3),i>=270&&(t+=3),i<=90&&(t-=3)},this.move=function(e){t=(t+e)%360},this.vector=function(){return t}};let o,a=0;this.spriteItem;let l,p,m,c=!1;function u(t,e,i,s=0,r=360){for(let n=s;n<r;n+=30)sp=t.sprite.itemCreate("BULLET_P",!0,8,8),sp.pos(e,i,n),sp.move(n,2,30)}function f(t,e){w={x:this.x,y:this.y,c:"white",r:this.r-90,draw(t){t.beginPath(),t.globalAlpha=1,t.strokeStyle=this.c,t.lineWidth=2,t.moveTo(this.x+12*Math.cos(this.r*(Math.PI/180)),this.y+12*Math.sin(this.r*(Math.PI/180))),t.lineTo(this.x+24*Math.cos(this.r*(Math.PI/180)),this.y+24*Math.sin(this.r*(Math.PI/180))),t.stroke()}},e.putFunc(w)}this.init=function(s){this.r=0,this.vr=0,this.x=this.spriteItem.x,this.y=this.spriteItem.y,this.old_x=this.x,this.old_y=this.y,this.triggerDelay=0,this.op.ptr=0,this.op.x.fill(this.x),this.op.y.fill(this.y),this.op.r.fill(0),this.spriteItem.mode=0,this.spriteItem.linkedOption=!1,t={sp:s.sprite.itemCreate("Turlet",!1,32,32),re:!1},t.sp.customDraw=f,t.sp.priority=1,e={sp:s.sprite.itemCreate("FRIEND_P",!0,32,32),re:!1},i={sp:s.sprite.itemCreate("Turlet",!1,32,32),re:!1},r={sp:s.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1},n={sp:s.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1},h={sp:s.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1},o=!1,c=!1,e.sp.dispose(),e.re=!0,i.sp.dispose(),i.re=!0,r.sp.dispose(),r.re=!0,n.sp.dispose(),n.re=!0,h.sp.dispose(),h.re=!0,p=s.beep.makeScore(["C2"],250,.3)},this.setNote=function(t){l=t,m=0},this.step=function(f,d,y){this.spriteItem.collisionEnable=!y.clrf;let g=d.x,I=d.y,w=d.trigger,x=!(!d.left&&!d.right);if(w&&this.triggerDelay<f.time()){this.triggerDelay=f.time()+250;let t=f.sprite.itemCreate(c?"BULLET_P2":"BULLET_P",!0,8,8),i=this.turlet.vector(),r=this.x+16*Math.cos(Math.PI/180*i),n=this.y+16*Math.sin(Math.PI/180*i);t.pos(r,n,0,.6),t.move((i+90)%360,6,3e3),e.sp.living&&(op=this.op,t=f.sprite.itemCreate("BULLET_P3",!0,8,8),t.pos(op.x[op.ptr%op.x.length],op.y[op.ptr%op.x.length],0,.6),t.move((op.r[op.ptr%op.x.length]+90)%360,6,3e3)),score=["E5","C5"],s=f.beep.makeScore(score,50,.5),l.play(s,f.time())}let b=3+a;Boolean(this.spriteItem.slow)&&(this.spriteItem.slow?(b/=2,this.spriteItem.slow=!1):this.spriteItem.slow=!1);let M=b*g,v=b*I;if(y.clrf&&0==M&&0==v){f.time(),y.time;M=Math.abs(320-this.x)/3<1?Math.trunc(320-this.x):Math.trunc((320-this.x)/3),v=Math.abs(320-this.y)/3<1?Math.trunc(320-this.y):Math.trunc((320-this.y)/3)}let P=!1,_=!!Boolean(this.spriteItem.wall)&&!!this.spriteItem.wall,E=!1,C=!1,G=!1,S=!1;if(this.spriteItem.living?(S=!!Boolean(this.spriteItem.mode)&&0!=this.spriteItem.mode,S&&(0!=(1&this.spriteItem.mode)&&(r.sp.living||(r={sp:f.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1})),0!=(2&this.spriteItem.mode)&&(n.sp.living||(n={sp:f.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1}),h.sp.living||(h={sp:f.sprite.itemCreate("ARMOR_P",!0,32,32),re:!1})),0!=(4&this.spriteItem.mode)&&(e.sp.living||(e={sp:f.sprite.itemCreate("FRIEND_P",!0,32,32),re:!1},i={sp:f.sprite.itemCreate("Turlet",!1,32,32),re:!1})),0!=(8&this.spriteItem.mode)&&(c=!c),this.spriteItem.mode=0),o=!1):o||(u(f,this.x,this.y),o=!0,t.sp.hide(),e.sp.living&&e.sp.dispose(),r.sp.living&&r.sp.dispose(),n.sp.living&&n.sp.dispose(),h.sp.living&&h.sp.dispose(),c=!1),e.sp.living?this.spriteItem.linkedOption=!0:(i.sp.living&&i.sp.dispose(),this.spriteItem.linkedOption=!1),r.sp.living&&(E=!!Boolean(r.wall)&&!!r.wall,r.wall=!1),n.sp.living&&(C=!!Boolean(r.wall)&&!!n.wall,n.wall=!1),h.sp.living&&(G=!!Boolean(r.wall)&&!!h.wall,h.wall=!1),P=!!(_||E||C||G),P&&(this.x=this.old_x,this.y=this.old_y,this.spriteItem.wall=!1),!o)if(x||this.turlet.check(this.r),0!=M||0!=v||y.clrf){this.old_x=Math.trunc(this.x),this.old_y=Math.trunc(this.y);let t=f.deltaTime()/(1e3/60);if(this.x=this.x+M*t,this.y=this.y+v*t,this.x<32&&(this.x=32),this.x>608&&(this.x=608),this.y<32&&(this.y=32),this.y>432&&(this.y=432),y.clrf||(this.r=this.turlet.vecToR(M,v)),op=this.op,op.x[op.ptr]=Math.trunc(this.x),op.y[op.ptr]=Math.trunc(this.y),op.r[op.ptr]=this.turlet.vector(),op.ptr++,op.ptr=op.ptr%op.x.length,f.time()>m&&(l.busy=!1),!l.busy&&!y.clrf){for(let t of p)t.use=!1;l.play(p,f.time()),m=f.time()+240}}else d.left&&this.turlet.move(-1),d.right&&this.turlet.move(1)},this.draw=function(s){if(e.sp.living){for(let t=0;t<this.op.x.length-5;t+=3){let e=this.op;s.screen[0].fill(e.x[(e.ptr+t)%e.x.length]-2,e.y[(e.ptr+t)%e.x.length]-2,3,3,"gray")}let t=this.op;e.sp.pos(t.x[t.ptr%t.x.length],t.y[t.ptr%t.x.length],t.r[t.ptr%t.x.length]+90,.8),i.sp.pos(t.x[t.ptr%t.x.length],t.y[t.ptr%t.x.length],t.r[t.ptr%t.x.length]+90,.8),e.sp.view(),i.sp.view()}else e.re||(u(s,op.x[op.ptr%op.x.length],op.y[op.ptr%op.x.length]),i.sp.dispose(),e.re=!0);let o=Math.trunc(this.x),a=Math.trunc(this.y);r.sp.living?(r.sp.pos(Math.trunc(o+20*Math.cos(this.r*(Math.PI/180))),Math.trunc(a+20*Math.sin(this.r*(Math.PI/180))),(this.r+90)%360,1),r.sp.view()):r.re||(u(s,o+20*Math.cos(this.r*(Math.PI/180)),a+20*Math.sin(this.r*(Math.PI/180))),r.re=!0),n.sp.living?(n.sp.pos(Math.trunc(o+20*Math.cos((this.r-90)*(Math.PI/180))),Math.trunc(a+20*Math.sin((this.r-90)*(Math.PI/180))),this.r%360,1),n.sp.view()):n.re||(u(s,o+16*Math.cos((this.r-90)*(Math.PI/180)),a+16*Math.sin((this.r-90)*(Math.PI/180))),n.re=!0),h.sp.living?(h.sp.pos(Math.trunc(o+17*Math.cos((this.r+90)*(Math.PI/180))),Math.trunc(a+17*Math.sin((this.r+90)*(Math.PI/180))),this.r%360,1),h.sp.view()):h.re||(u(s,Math.trunc(o+16*Math.cos((this.r+90)*(Math.PI/180))),Math.trunc(a+16*Math.sin((this.r+90)*(Math.PI/180)))),h.re=!0),this.spriteItem.pos(o,a,(this.r+90)%360,1),this.spriteItem.view(),t.sp.living&&(t.sp.pos(o,a,(this.turlet.vector()+90)%360,1),t.sp.r=(this.turlet.vector()+90)%360,t.sp.view())}}function GameObj_Friend(){}function GameObj_Enemy(){}function GameObj_FlyCanon(){this.r=0,this.vr=0,this.x=0,this.y=0,this.old_X=0,this.old_y=0,this.triggerDelay=0,this.triggerCount=0;let t,e,i;function s(t,e,i){const s=t.sprite.itemList();let n=999,h=-1;for(let t in s)if("Player"==s[t].id||"FRIEND_P"==s[t].id){let o=r({x:e,y:i},s[t]);o<=n&&(h=t,n=o)}let o=-1;return-1!=h&&(o=function(t,e){return(270+(0==t?e>=0?180:0:Math.atan(e/t)*(180/Math.PI)+(t>=0?90:270)))%360}(e-s[h].x,i-s[h].y)),o}function r(t,e){return Math.sqrt(Math.abs(e.x-t.x)*Math.abs(e.x-t.x)+Math.abs(e.y-t.y)*Math.abs(e.y-t.y))}this.spriteItem,this.init=function(s,r=1e3,n=10){this.r=this.spriteItem.r,this.vr=0,this.x=this.spriteItem.x,this.y=this.spriteItem.y,this.old_X=this.x,this.old_y=this.y,this.triggerDelay=0,this.triggerCount=0,t=!1,e=r,i=n},this.step=function(r,n,h){if(this.spriteItem.living){if(this.triggerDelay<r.time()){if(this.triggerDelay=r.time()+e,this.triggerCount++,this.triggerCount%2>0){let t=r.sprite.itemCreate("BULLET_E",!0,4,4),e=s(r,this.x,this.y),i=-1!=e?e-90:this.r+(r.time()%180+90);this.triggerCount%3==0&&(i=this.r);let n=this.x,h=this.y;t.pos(n,h,0,1),t.move(i,3,3e3)}this.r+=i,this.spriteItem.move(this.r,2,100)}t=!1}else t||(!function(t,e,i,s=0,r=360){for(let n=s;n<r;n+=30)sp=t.sprite.itemCreate("BULLET_E",!0,8,8),sp.pos(e,i,n),sp.move(n,2,30)}(r,this.x,this.y),t=!0);!!Boolean(this.spriteItem.wall)&&!!this.spriteItem.wall&&(this.r+=5*i,this.r=this.r%360,this.spriteItem.vx=0,this.spriteItem.vy=0,this.spriteItem.wall=!1),Boolean(this.spriteItem.slow)&&(this.spriteItem.slow?(this.spriteItem.vx/=1.05,this.spriteItem.vy/=1.05,this.spriteItem.slow=!1):this.spriteItem.slow=!1),t||(this.old_x=this.x,this.old_y=this.y,this.x=this.spriteItem.x,this.y=this.spriteItem.y,this.r=this.spriteItem.r,this.x<32&&(this.spriteItem.x=32),this.x>608&&(this.spriteItem.x=608),this.y<32&&(this.spriteItem.y=32),this.y>432&&(this.spriteItem.y=432))},this.draw=function(t){this.spriteItem.living&&this.spriteItem.view()}}function GameObj_Horming(){}function GameObj_GradeUpItem(){let t;function e(t,e,i){const s=t.sprite.itemList();let r=-1;for(let t in s)"Player"==s[t].id&&(r=t);let n=-1;return-1!=r&&(n=function(t,e){return(270+(0==t?e>=0?180:0:Math.atan(e/t)*(180/Math.PI)+(t>=0?90:270)))%360}(e-s[r].x,i-s[r].y)),n}this.triggerDelay=0,this.mode=0,this.blink=!0,this.barth=!0,this.spriteItem,this.init=function(e){this.triggerDelay=e.time()+250,this.mode=0,this.barth=!0,this.spriteItem.mode=this.mode,this.spriteItem.drawDesignData=i,this.spriteItem.blink=!0,t=!1,this.spriteItem.normalDrawEnable=!1,this.spriteItem.customDraw=s,this.spriteItem.moveFunc=function(t){let e=t/(1e3/60);this.alive--,this.x+=this.vx*e,this.y+=this.vy*e}},this.step=function(i,s,r){if(this.spriteItem.collisionEnable=!this.barth,r.clrf&&r.time+750>i.time()){let t=e(i,this.spriteItem.x,this.spriteItem.y);this.spriteItem.move((t+260)%360,4,1)}if(this.spriteItem.living?(this.triggerDelay<i.time()&&(this.triggerDelay=i.time()+250,this.mode=this.spriteItem.mode!=this.mode?this.spriteItem.mode:this.mode,this.spriteItem.priority=this.mode,this.blink=!this.blink,this.spriteItem.blink=this.blink,this.barth=!1),t=!1):t||(t=!0),t)return;const n=this.spriteItem.x,h=this.spriteItem.y;this.spriteItem.r;n<32&&(this.spriteItem.x=32),n>608&&(this.spriteItem.x=608),h<32&&(this.spriteItem.y=32),h>432&&(this.spriteItem.y=432)},this.draw=function(t){this.spriteItem.living&&this.spriteItem.view()};const i={str:[["得点","正面","側面","子機","弾種"],[" 300","FWD","SIDE"," OPT","CHNG"]],color:[["black","peru","navy","teal","indigo"],["rgb(64,64,64)","orange","blue","green","blueviolet"]]};function s(t,e){const i=this.drawDesignData.str,s=this.drawDesignData.color;let r=this.blink?0:1;const n=Math.trunc(this.x-this.collision.w/2),h=Math.trunc(this.y-this.collision.h/2),o=this.collision.w,a=this.collision.h;e.fill(n,h,o,a,"white"),e.fill(n+1,h+1,o-2,a-2,s[r][this.mode]),t.kanji.print(i[r][this.mode],n+2,h+4)}}function GameObj_Mine(){let t,e;this.triggerDelay=0,this.turlet=new function(){let t=0;function e(t,e,s){const r=t.sprite.itemList();let n=999,h=-1;for(let t in r)if("Enemy"==r[t].id){let o=i({x:e,y:s},r[t]);o<=n&&(h=t,n=o)}let o=-1;return-1!=h&&(o=function(t,e){return(270+(0==t?e>=0?180:0:Math.atan(e/t)*(180/Math.PI)+(t>=0?90:270)))%360}(e-r[h].x,s-r[h].y)),(o+180)%360}function i(t,e){return Math.sqrt(Math.abs(e.x-t.x)*Math.abs(e.x-t.x)+Math.abs(e.y-t.y)*Math.abs(e.y-t.y))}this.check=function(i,s,r){!function(e){let i=Math.trunc(180+e-t)%360;i>=180&&t++,i<=180&&t--,i>=210&&(t+=3),i<=150&&(t-=3),i>=270&&(t+=3),i<=90&&(t-=3)}(e(i,s,r))},this.move=function(e){t=(t+e)%360},this.vector=function(){return t}},this.spriteItem,this.init=function(i){this.triggerDelay=0,t={sp:i.sprite.itemCreate("Turlet",!1,32,32),re:!1},t.sp.priority=1,e=!1},this.step=function(i,s,r){if(this.spriteItem.living){if(this.spriteItem.collisionEnable=!r.clrf,!r.clrf&&(this.turlet.check(i,this.spriteItem.x,this.spriteItem.y),this.triggerDelay<i.time())){this.triggerDelay=i.time()+1e3;let t=i.sprite.itemCreate("BULLET_P3",!0,8,8),e=this.turlet.vector(),s=this.spriteItem.x+16*Math.cos(Math.PI/180*e),r=this.spriteItem.y+16*Math.sin(Math.PI/180*e);t.pos(s,r,0,.6),t.move((e+90)%360,6,3e3)}e=!1}else e||(!function(t,e,i,s=0,r=360){for(let n=s;n<r;n+=30)sp=t.sprite.itemCreate("BULLET_P",!0,8,8),sp.pos(e,i,n),sp.move(n,2,30)}(i,this.spriteItem.x,this.spriteItem.y),e=!0,t.sp.dispose())},this.draw=function(e){let i=Math.trunc(this.spriteItem.x),s=Math.trunc(this.spriteItem.y);this.spriteItem.pos(i,s,(this.r+90)%360,.8),this.spriteItem.view(),t.sp.living&&(t.sp.pos(i,s,(this.turlet.vector()+90)%360,.8),t.sp.r=(this.turlet.vector()+90)%360,t.sp.view())}}function SceneGame(){let t,e,i,r,n,h,o,a,l,p,m;function c(){let t,e;this.run=function(){t++},this.set=function(){e=0,t=0},this.check=function(){return t!=e}}this.state=function(){return{ene:a,result:i,time:h,stage:i.stage,score:i.score,delay:r,block:undefined,collision:0,sprite:e.length,clear:i.clrf,gameover:i.govf}},this.init=function(i){l=new c,t=[],p=new StageControl(i),p.init(),e=i.sprite.itemList(),m=[],i.beep.oscSetup(1),i.beep.lfoReset(),m[0]=i.beep.createNote(1),i.beep.oscSetup(0),i.beep.lfoSetup(10,0,50),m[1]=i.beep.createNote(1),i.beep.oscSetup(1),i.beep.lfoSetup(24,3,20),m[2]=i.beep.createNote(1);for(let t of m)t.on(0);this.reset(i)},this.reset=function(s){p.init(),t=[],s.sprite.itemFlash(),o=new GameObject,o.spriteItem=s.sprite.itemCreate("Player",!0,28,28),o.spriteItem.pos(320,320),o.init(s),o.setNote(m[1]),t.push(o),p.change(1,t);for(let t in this.spriteTable)e[t].visible=!1;a={now:3,max:3,before:this.now},i={score:0,time:s.time(),stage:1,clrf:!1,govf:!1},r=0,n=0},this.step=function(n,c,u){h=Math.trunc((n.time()-i.time)/100);for(let e of t)e.step(n,c,i);if(r<n.time()){r=n.time()+500,a.before=a.now,n.sprite.itemIndexRefresh();let e=0,s=n.sprite.itemList();for(let t of s)"Enemy"==t.id&&e++;if(!o.spriteItem.living&&(a.now--,a.now>0)){o.spriteItem=n.sprite.itemCreate("Player",!0,28,28),o.spriteItem.pos(320,320),o.x=320,o.y=320;let t=["E4","E#4","G5"],e=n.beep.makeScore(t,150,1);m[0].play(e,n.time())}if(i.score>5e3*(a.max-2)){const t=n.sprite.itemCreate("BULLET_P",!1,1,1);t.priority=5,t.normalDrawEnable=!1,t.customDraw=function(t,e){let i=Math.trunc(this.x-28),s=Math.trunc(this.y);e.fill(i,s,48,8,"Black"),t.kanji.print("Extend.",i,s)},t.pos(o.x,o.y),t.move(0,1,45),a.now++,a.max++}if(0==e)if(i.clrf){i.time=n.time(),i.stage++;let e=[];for(let i in t)t[i].spriteItem.living&&e.push(t[i]);t=e,p.change(i.stage,t);let s=n.sprite.itemList();for(let t of s)"BULLET_P"==t.id&&t.dispose(),"BULLET_E"==t.id&&t.dispose()}else{i.clrf=!0,r=n.time()+3e3;let t=["G4","C5","E5","G5","G5"],e=n.beep.makeScore(t,100,1);m[0].play(e,n.time())}else i.clrf=!1;if(a.now<=0){r=n.time()+3e3,a.now=0,i.govf=!0;let t=["F4","E4","D4","C4","B3","B#3","C4"],e=n.beep.makeScore(t,150,1);m[0].play(e,n.time())}}n.sprite.CollisionCheck(),e=n.sprite.itemList();for(let r in e){let h=e[r];if(h.living&&(h.collisionEnable&&h.visible)){if("Player"==h.id||"FRIEND_P"==h.id||"ARMOR_P"==h.id){let e=h.hit;for(let r in e){let o=e[r];if(o.visible&&("BULLET_E"==o.id&&(p.mapDamage(h),h.dispose(),o.dispose(),score=["E4","D4","C4","B3"],s=n.beep.makeScore(score,50,1),m[2].play(s,n.time())),"Player"==h.id&&"POWERUP"==o.id)){if(o.mode>0&&(Boolean(h.mode)&&isNaN(h.mode)?h.mode+=Math.pow(2,o.mode-1):h.mode=Math.pow(2,o.mode-1)),3==o.mode&&h.linkedOption){let e=new GameObj_Mine;e.spriteItem=n.sprite.itemCreate("FRIEND_P",!0,24,24),e.spriteItem.pos(h.x,h.y),e.init(n),t.push(e)}i.score+=0==o.mode?300:0,o.dispose(),score=["C6","C5"],s=n.beep.makeScore(score,50,1),m[0].play(s,n.time())}}}if("Enemy"==h.id){let e=h.hit;for(let r in e){let o=e[r];if(o.visible&&"BULLET_P"==o.id.substring(0,8)){p.mapDamage(h);let e=new GameObj_GradeUpItem;e.spriteItem=n.sprite.itemCreate("POWERUP",!1,28,16),e.spriteItem.pos(h.x,h.y),e.init(n),t.push(e),h.dispose(),o.dispose(),i.score+=10,score=["A3","A2"],s=n.beep.makeScore(score,50,1),m[2].play(s,n.time());break}}}if("BULLET_P"==h.id.substring(0,8)){let t=h.hit;for(let e in t){let i=t[e];i.visible&&("BULLET_E"==i.id&&(p.mapDamage(h),h.dispose(),i.dispose(),score=["C3"],s=n.beep.makeScore(score,50,1),m[2].play(s,n.time())))}}if("BULLET_E"==h.id){let t=h.hit;for(let e in t){let i=t[e];i.visible&&("BULLET_P"==h.id.substring(0,8)&&(p.mapDamage(h),h.dispose(),i.dispose(),score=["C3"],s=n.beep.makeScore(score,50,1),m[2].play(s,n.time())))}}if("POWERUP"==h.id){let t=h.hit;for(let e in t){let i=t[e];i.visible&&("BULLET_"==i.id.substring(0,7)&&(h.mode++,h.mode>4&&(h.mode=0),h.x-=(i.x-h.x)/5,h.y-=(i.y-h.y)/5,i.dispose(),score=["C4","E5"],s=n.beep.makeScore(score,50,.5),m[2].play(s,n.time())),i.id==h.id&&Math.trunc(i.x)==Math.trunc(h.x)&&Math.trunc(i.y)==Math.trunc(h.y)&&(h.vx=2*(4*Math.random()-2),h.vy=2*(4*Math.random()-2)))}}}}!function(t){for(let e in t){let i=t[e];(i.x<0||i.x>640||i.y<0||i.y>464)&&((i.x<0||i.x>640)&&i.dispose(),(i.y<0||i.y>464)&&i.dispose())}}(n.sprite.itemList()),p.step(n,c,i),l.run()},this.draw=function(e){l.check();if(1){let t=e.sprite.itemList();for(let i in t)"BULLET"==t[i].id.substring(0,6)&&e.screen[0].fill(t[i].x-t[i].collision.w/2,t[i].y-t[i].collision.h/2,t[i].collision.w,t[i].collision.h,"BROWN")}if(p.draw(e),!i.govf)for(let i of t)i.draw(e);l.set()}}class GameTask_Main extends GameTask{_x=0;_y=0;_sm={};_dtt=0;_result;_titlef;titlewait;_wh=0;scene;_dv;note;constructor(t){super(t)}pre(t){this.scene=[],this.scene.Game=new SceneGame,this.scene.UI=new SceneGameUI,this.scene.Debug=new SceneDebug,this.scene.Result=new SceneResult,this.scene.GameOver=new SceneGameOver,this.scene.Title=new SceneTitle,this.scene.Gpad=new SceneGPad,this.scene.VGpad=new SceneVGPad,t.sprite.setPattern("Player",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:32,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("Turlet",{image:"SPGraph",wait:0,pattern:[{x:0,y:32,w:32,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("BULLET_P",{image:"SPGraph",wait:0,pattern:[{x:48,y:48,w:8,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("BULLET_P2",{image:"SPGraph",wait:0,pattern:[{x:16,y:16,w:8,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("BULLET_P3",{image:"SPGraph",wait:0,pattern:[{x:48,y:48,w:8,h:8,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("Enemy",{image:"SPGraph",wait:10,pattern:[{x:32,y:32,w:32,h:32,r:0,fv:!1,fh:!1},{x:32,y:64,w:32,h:32,r:0,fv:!1,fh:!1},{x:32,y:96,w:32,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("BULLET_E",{image:"SPGraph",wait:0,pattern:[{x:48,y:48,w:4,h:16,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("ARMOR_P",{image:"SPGraph",wait:0,pattern:[{x:0,y:64,w:32,h:8,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("ARMOR_E",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:2,h:2,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("FRIEND_P",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:32,h:32,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("POWERUP",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:2,h:2,r:0,fv:!1,fh:!1}]}),t.sprite.setPattern("block",{image:"SPGraph",wait:0,pattern:[{x:0,y:0,w:2,h:2,r:0,fv:!1,fh:!1}]}),this.scene.Game.init(t),this._initGame(t),this._sm={x:0,y:0,old_x:0,old_y:0},t.beep.oscSetup(1),t.beep.lfoReset(),this.note=t.beep.createNote(1),this.note.on(0);let e=t.beep.makeScore(["C5","C6"],100,.1);this.note.play(e,t.time()+250)}_initGame(t){this.scene.Game.reset(t),this._titlef=!0,this.titlewait=t.time()+1e3}step(t){let e=t.keyboard.check(),i=!1;Boolean(e[65])&&e[65]&&(i=!0);let s=!1;Boolean(e[68])&&e[68]&&(s=!0);let r=!1;Boolean(e[87])&&e[87]&&(r=!0);let n=!1;Boolean(e[83])&&e[83]&&(n=!0);let h=!1;Boolean(e[81])&&e[81]&&(h=!0);let o=!1;Boolean(e[69])&&e[69]&&(o=!0);let a=!1;Boolean(e[38])&&e[38]&&(a=!0);let l=!1;Boolean(e[40])&&e[40]&&(l=!0);let p=!1;Boolean(e[37])&&e[37]&&(p=!0);let m=!1;Boolean(e[39])&&e[39]&&(m=!0);let c=!1;Boolean(e[32])&&e[32]&&(c=!0);let u=!1;Boolean(e[90])&&e[90]&&(u=!0);let f=!1;Boolean(e[36])&&e[36]&&(f=!0);let d=!1;Boolean(e[80])&&e[80]&&(d=!0);let y=t.gamepad.check(),g=t.gamepad.btn_lb,I=t.gamepad.btn_rb,w=t.gamepad.btn_a,x=t.gamepad.btn_x,b=t.gamepad.btn_back,M=t.gamepad.r,v=t.gamepad.axes;a=!(!a&&!r),l=!(!l&&!n),p=!(!p&&!i),m=!(!m&&!s),!(!f&&!b)&&(document.fullscreenElement||t.systemCanvas.requestFullscreen());let P=t.vgamepad.check(),_=!1;Boolean(P.button[0])&&P.button[0]&&(_=!0);let E=!1;Boolean(P.button[1])&&P.button[1]&&(E=!0);let C=!1;Boolean(P.button[2])&&P.button[2]&&(C=!0);let G=!1;if(Boolean(P.button[3])&&P.button[3]&&(G=!0),y&&-1!=M)this._x=v[0],this._y=v[1];else if(-1!=P.distance){let t=(P.deg-90)*(Math.PI/180);this._x=Math.cos(t),this._y=Math.sin(t)}else this._x=p?-1:m?1:0,this._y=a?-1:l?1:0;let S=g||u||h||_,k=I||u||o||E,L=w||x||c||G,B={x:this._x,y:this._y,trigger:L,left:S,right:k,keycode:e},T=this.scene.Game.state();if(this._result=T.result,this._titlef){if(T.block=0,T.sprite=0,this.scene.Title.step(t,B,{delay:this.titlewait})){this._titlef=!1;let e=["C4","C3","C4","G4","A0","C5"],i=t.beep.makeScore(e,150,1);this.note.play(i,t.time())}}else T.gameover?this.scene.GameOver.step(t,B,T)&&this._initGame(t):this.scene.Game.step(t,B);this._result.clrf&&this.scene.Result.step(t,B),this.scene.UI.step(t,B,T),this.scene.Debug.step(t,B,T),this._dv=!!d,this._dv&&this.scene.Gpad.step(t,B,T),this.scene.VGpad.step(t,B,T)}draw(t){this._titlef||this.scene.Game.draw(t),this._titlef||this.scene.UI.draw(t),this._dv&&this.scene.Debug.draw(t),this._result.clrf&&this.scene.Result.draw(t),this._result.govf&&this.scene.GameOver.draw(t),this._titlef&&this.scene.Title.draw(t),this._dv&&this.scene.Gpad.draw(t),this.scene.VGpad.draw(t)}}function main(){const t=new GameCore({canvasId:"layer0",screen:[{resolution:{w:640,h:480,x:0,y:0}}]});pictdata(t);const e=SpriteFontData();for(let i in e)t.setSpFont(e[i]);t.kanji=new fontPrintControl(t,t.asset.image.ASCII.img,6,8,t.asset.image.JISLV1.img,12,8),t.task.add(new GameTask_Main("main")),t.screen[0].setBackgroundcolor("black"),t.screen[0].setInterval(1),t.run()}function SpriteFontData(){let t=[];for(let e=0;e<7;e++)for(j=0;j<16;j++)ptn={x:12*j,y:16*e,w:12,h:16},t.push(ptn);let e=[],i=["white","red","green","blue"];for(let t=0;t<=3;t++){let s=[];for(let t=0;t<7;t++)for(let e=0;e<16;e++)ptn={x:6*e,y:8*t+16,w:6,h:8},s.push(ptn);e[i[t]]=s}return[{name:"std",id:"ASCII",pattern:e.white},{name:"8x8red",id:"ASCII",pattern:e.red},{name:"8x8green",id:"ASCII",pattern:e.green},{name:"8x8blue",id:"ASCII",pattern:e.blue},{name:"8x8white",id:"ASCII",pattern:e.white}]}function pictdata(t){t.asset.imageLoad("SPGraph","pict/cha.png"),t.asset.imageLoad("JISLV1","pict/k12x8_jisx0208c.png"),t.asset.imageLoad("ASCII","pict/k12x8_jisx0201c.png")}function SceneGameUI(){let t,e,i;this.step=function(s,r,n){t=n.ene,e=n.result,i=n.time},this.draw=function(i){let s="";for(let e=1;e<t.now;e++)s+="▲";i.kanji.print("PLAYER:"+s,0,448),i.kanji.print("STAGE :"+e.stage+" SCORE:"+Math.trunc(e.score),0,456)}}function SceneResult(){this.step=function(t,e){},this.draw=function(t){t.font.std.putchr("STAGE CLEAR",220,244,3),t.font.std.putchr("STAGE CLEAR",320,464)}}function SceneTitle(){let t;const e=["テーマ  アップグレード/強化(土日スレ16)","","     TANK BATTLE Style/ERA-TANK","","","","","","           START SPACE KEY","                     or GamePad Button X/A","","","","[操作]移動    : WASD or 矢印キー or GamePad 左アナログスティック","      攻撃    : SPACE key or GamePad Button X/A","攻撃方向の固定: Z key  or GamePad Button L/R","停止時砲塔旋回: Q,Ekey or GamePad Button L/R","","","敵を倒すと出てくるアップグレードパーツ(弾を当てて切り替え)","[得点/300 ] 得点300点 (Extend5000点)","[正面/FWD ] 正面追加装甲","[側面/SIDE] 側面追加装甲","[子機/ OPT] ターレット(1台目OPTION/以降 設置型)","[弾種/CHNG] 弾の種類切り替え(通常<->ブロック貫通)","  注：重複効果はありません。"];this.step=function(e,i,s){t=i,delay=s.delay-e.time()<0;let r=!1;return delay&&i.trigger&&(r=!0),r},this.draw=function(t){for(let i in e)t.kanji.print(e[i],160,140+8*i)}}function SceneGameOver(){let t,e,i;this.step=function(s,r,n){if(t=n.stage,e=Math.trunc(n.score),i=n.delay-s.time()<0,i&&(s.sprite.itemFlash(),r.trigger))return!0},this.draw=function(t){t.font.std.putchr("GAME OVER",220,248,4),t.font["8x8white"].putchr(":"+(i?"OK":"WAIT"),320,456)}}function SceneDebug(){let t,e,i,s,r;this.step=function(n,h,o){t=o.block,e=n.deltaTime().toString().substring(0,5),i=o.collision,s=o.sprite,r=h},this.draw=function(t){t.font["8x8white"].putchr("DeltaT:"+e,540,0);let i=0!=r.x?r.x>0?"R":"L":"-",s=0!=r.y?r.y>0?"D":"U":"-",n=r.trigger?"T":"-",h=r.right?"S":"-";t.font["8x8green"].putchr("Input:"+s+":"+i+":"+n+":"+h,540,16)}}function SceneGPad(){let t;this.step=function(e,i,s){t=e.gamepad.infodraw();let r=i.keycode,n="";for(let t in r)Boolean(r[t])&&(n+="["+t+"]");t.push(""),t.push("[Keyboard]"),t.push(n)},this.draw=function(e){for(let i in t)e.font["8x8white"].putchr(t[i],0,48+8*i)}}function SceneVGPad(){let t;this.step=function(e,i,s){let r=e.vgamepad.check();t=[],t.push("state button:"+r.button),t.push("state deg   :"+r.deg),t.push("state distance:"+r.distance)},this.draw=function(e){e.vgamepad.draw(e.screen[0]);let i={draw:function(t){t.globalAlpha=1}};e.screen[0].putFunc(i);for(let e in t);}}function StageControl(t){const e=60,i=80;let s,r,n,h=t;function o(t,e,i,r,n){for(let h=e;h<e+r;h++)for(let e=t;e<t+i;e++)s[h][e].on=n.on,s[h][e].break=n.break,s[h][e].hit=n.hit,s[h][e].hp=n.hp}this.init=function(){n=1,s=function(t){let s=new Array(e);for(let r=0;r<e;r++){s[r]=new Array(i);for(let e=0;e<i;e++)s[r][e]={},s[r][e].on=t.on,s[r][e].break=t.break,s[r][e].hit=t.hit,s[r][e].hp=t.hp}return s}({on:!1,break:!1,hit:!1,hp:5})},this.change=function(t,e){n=t;!function(t){const e=Math.trunc(i/6),s=Math.trunc(12);let r=parseInt(t,16);for(let t=0;t<5;t++)for(let i=0;i<6;i++)0!=(1&r)&&o(i*e,t*s,e,s,{on:!0,break:!1,hit:!1,hp:1}),r>>=1}(["00000000","0000C000","00000080","00000400","00080000","00400000","00021000"][n%7]);let s=new GameObj_FlyCanon;s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28);let r=n%2==0?-1:1,a=Math.trunc(n/10)+1,l=Math.trunc(300*Math.random());s.spriteItem.pos(320+160*r,30),s.init(h,1e3/a+l,10/a*r),e.push(s),n>=3&&(l=Math.trunc(300*Math.random()),s=new GameObj_FlyCanon,s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28),s.spriteItem.pos(320,30),s.spriteItem.move(180,2,1e3),s.init(h,1e3/a+l,5*r),e.push(s)),n>=5&&(l=Math.trunc(300*Math.random()),s=new GameObj_FlyCanon,s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28),s.spriteItem.pos(320-160*r,30),s.init(h,1e3/a+l,10/a*-r),e.push(s)),n>=7&&(l=Math.trunc(300*Math.random()),s=new GameObj_FlyCanon,s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28),s.spriteItem.pos(320-280*r,30),s.spriteItem.move(180,2,1e3),s.init(h,1e3/a+l,10/a*-r),e.push(s),l=Math.trunc(300*Math.random()),s=new GameObj_FlyCanon,s.spriteItem=h.sprite.itemCreate("Enemy",!0,28,28),s.spriteItem.pos(320+280*r,30),s.spriteItem.move(180,2,1e3),s.init(h,1e3/a+l,10/a*r),e.push(s))},this.step=function(t,e,i){let r=t.sprite.itemList();for(let t in r){let e=r[t],i=r[t];if(!i.living)continue;if(!i.collisionEnable)continue;if(!i.visible)continue;let s=e.collision.w,h=e.collision.h;for(let t=Math.trunc((e.x-s/2)/8);t<=Math.trunc((e.x+s/2)/8);t++)for(let i=Math.trunc((e.y-h/2)/8);i<=Math.trunc((e.y+h/2)/8);i++)n(e,t,i)}function n(t,e,r){r>=0&&r<s.length&&e>=0&&e<s[r].length&&(s[r][e].on&&("BULLET_P"==t.id.substring(0,8)&&(s[r][e].hp--,s[r][e].hp<0&&(s[r][e].on=!1,s[r][e].break=!0,s[r][e].hit=!1),"BULLET_P2"!=t.id&&t.dispose(),i.score++),"BULLET_E"==t.id&&(s[r][e].hp--,s[r][e].hp<0&&(s[r][e].on=!1,s[r][e].break=!0,s[r][e].hit=!1),t.dispose()),"Player"==t.id&&(t.wall=!0,s[r][e].on=!1,s[r][e].break=!0,s[r][e].hit=!0),"ARMOR_P"==t.id&&(t.wall=!0),"Enemy"==t.id&&(t.wall=!0)),s[r][e].hit&&("Player"==t.id&&(t.slow=!0),"Enemy"==t.id&&(t.slow=!0)))}},this.mapDamage=function(t){let r=t,n=r.collision.w,h=r.collision.h;for(let t=Math.trunc((r.x-n/2)/8);t<=Math.trunc((r.x+n/2)/8);t++)for(let n=Math.trunc((r.y-h/2)/8);n<=Math.trunc((r.y+h/2)/8);n++)t>=0&&t<i&&n>=0&&n<e&&(s[n][t].hit=!0)},this.draw=function(t){let n=Math.trunc(t.time()/250)%2;r=0;for(let h=0;h<e;h++)for(let e=0;e<i;e++)s[h][e].on&&(0!=s[h][e].hp?(t.screen[0].fill(8*e,8*h,8,8,"lightgray"),t.screen[0].fill(8*e,8*h,7,7,"gray")):t.screen[0].fill(8*e+1,8*h+1,5,5,"gray"),r++),s[h][e].hit&&(0==n?t.screen[0].fill(8*e+4,8*h+4,2,1,"red"):t.screen[0].fill(8*e+4,8*h+4,1,1,"red"))}}